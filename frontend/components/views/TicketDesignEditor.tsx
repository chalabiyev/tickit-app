"use client"

import { useState, useRef } from "react"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { Slider } from "@/components/ui/slider"
import { Separator } from "@/components/ui/separator" // ДОБАВЛЕНО!
import { QrCode, Type, Palette, Maximize, Trash, Image as ImageIcon, LayoutTemplate, AlignLeft, AlignCenter, AlignRight, Upload, Loader2 } from "lucide-react"
import { cn } from "@/lib/utils"

export type ElementType = 'text' | 'qr'

export interface TicketElement {
  id: string; type: ElementType; x: number; y: number; content: string; color: string; 
  fontSize: number; fontWeight: 'normal' | 'bold'; fontFamily?: 'sans' | 'serif' | 'mono'; textAlign?: 'left' | 'center' | 'right';
}

export interface TicketDesign {
  bgColor: string; bgImage: string | null; bgOverlay: number; elements: TicketElement[]
}

interface TicketDesignEditorProps {
  design: TicketDesign; onChange: (d: TicketDesign) => void; eventDetails: { title: string; date: string; location: string };
}

const TEMPLATES: Record<string, TicketDesign> = {
  minimalDark: { bgColor: "#121212", bgImage: null, bgOverlay: 0, elements: [{ id: 'qr-1', type: 'qr', x: 100, y: 380, content: 'QR_CODE', color: '#ffffff', fontSize: 120, fontWeight: 'normal' }, { id: 't-1', type: 'text', x: 20, y: 40, content: '{{Event_Name}}', color: '#ffffff', fontSize: 28, fontWeight: 'bold', fontFamily: 'sans', textAlign: 'left' }, { id: 't-2', type: 'text', x: 20, y: 85, content: '{{Event_Date}} • {{Location}}', color: '#a1a1aa', fontSize: 12, fontWeight: 'normal', fontFamily: 'sans', textAlign: 'left' }, { id: 't-3', type: 'text', x: 20, y: 150, content: '{{Guest_Name}}', color: '#ffffff', fontSize: 20, fontWeight: 'normal', fontFamily: 'mono', textAlign: 'left' }, { id: 't-4', type: 'text', x: 20, y: 180, content: '{{Ticket_Type}}', color: '#3b82f6', fontSize: 16, fontWeight: 'bold', fontFamily: 'sans', textAlign: 'left' }] },
  goldVip: { bgColor: "#0f172a", bgImage: null, bgOverlay: 0, elements: [{ id: 'qr-1', type: 'qr', x: 100, y: 360, content: 'QR_CODE', color: '#ffffff', fontSize: 120, fontWeight: 'normal' }, { id: 't-1', type: 'text', x: 160, y: 50, content: '{{Event_Name}}', color: '#d4af37', fontSize: 26, fontWeight: 'bold', fontFamily: 'serif', textAlign: 'center' }, { id: 't-2', type: 'text', x: 160, y: 140, content: 'V I P   T I C K E T', color: '#d4af37', fontSize: 14, fontWeight: 'bold', fontFamily: 'sans', textAlign: 'center' }, { id: 't-3', type: 'text', x: 160, y: 170, content: '{{Guest_Name}}', color: '#ffffff', fontSize: 22, fontWeight: 'normal', fontFamily: 'serif', textAlign: 'center' }] },
  neonParty: { bgColor: "#000000", bgImage: null, bgOverlay: 0, elements: [{ id: 'qr-1', type: 'qr', x: 100, y: 380, content: 'QR_CODE', color: '#ffffff', fontSize: 120, fontWeight: 'normal' }, { id: 't-1', type: 'text', x: 20, y: 40, content: '{{Event_Name}}', color: '#a855f7', fontSize: 32, fontWeight: 'bold', fontFamily: 'mono', textAlign: 'left' }, { id: 't-2', type: 'text', x: 20, y: 90, content: '{{Event_Date}}', color: '#22c55e', fontSize: 16, fontWeight: 'bold', fontFamily: 'mono', textAlign: 'left' }, { id: 't-3', type: 'text', x: 20, y: 160, content: '{{Guest_Name}}', color: '#ffffff', fontSize: 24, fontWeight: 'bold', fontFamily: 'sans', textAlign: 'left' }, { id: 't-4', type: 'text', x: 20, y: 195, content: '{{Ticket_Type}} | {{Seat_Info}}', color: '#a855f7', fontSize: 14, fontWeight: 'normal', fontFamily: 'mono', textAlign: 'left' }] }
}

export function TicketDesignEditor({ design, onChange, eventDetails }: TicketDesignEditorProps) {
  const containerRef = useRef<HTMLDivElement>(null)
  const fileInputRef = useRef<HTMLInputElement>(null)
  const [selectedId, setSelectedId] = useState<string | null>(null)
  const [isDragging, setIsDragging] = useState(false)
  const [isUploading, setIsUploading] = useState(false)
  const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 })

  const selectedElement = design.elements.find(e => e.id === selectedId)

  const renderSmartPreview = (content: string) => {
    return content.replace(/{{Event_Name}}/g, eventDetails.title || "My Awesome Event").replace(/{{Event_Date}}/g, eventDetails.date || "12.12.2026").replace(/{{Location}}/g, eventDetails.location || "Baku, AZ").replace(/{{Guest_Name}}/g, "John Doe").replace(/{{Ticket_Type}}/g, "VIP").replace(/{{Seat_Info}}/g, "Row 1, Seat 12");
  }

  const handlePointerDown = (e: React.PointerEvent, id: string) => { e.stopPropagation(); setSelectedId(id); setIsDragging(true); const el = design.elements.find(el => el.id === id); if (el) setDragOffset({ x: e.clientX - el.x, y: e.clientY - el.y }); containerRef.current?.setPointerCapture(e.pointerId) }
  const handlePointerMove = (e: React.PointerEvent) => { if (!isDragging || !selectedId) return; const container = containerRef.current?.getBoundingClientRect(); if (!container) return; let newX = e.clientX - dragOffset.x; let newY = e.clientY - dragOffset.y; onChange({ ...design, elements: design.elements.map(el => el.id === selectedId ? { ...el, x: newX, y: newY } : el) }) }
  const handlePointerUp = (e: React.PointerEvent) => { setIsDragging(false); if (containerRef.current?.hasPointerCapture(e.pointerId)) containerRef.current.releasePointerCapture(e.pointerId) }

  const updateSelected = (updates: Partial<TicketElement>) => { if (!selectedId) return; onChange({ ...design, elements: design.elements.map(el => el.id === selectedId ? { ...el, ...updates } : el) }) }
  const addElement = (content: string, type: ElementType = 'text') => { const newEl: TicketElement = { id: `el-${Date.now()}`, type, x: 20, y: 200, content, color: '#ffffff', fontSize: 18, fontWeight: 'normal', fontFamily: 'sans', textAlign: 'left' }; onChange({ ...design, elements: [...design.elements, newEl] }); setSelectedId(newEl.id) }
  const deleteSelected = () => { if (!selectedId) return; if (selectedElement?.type === 'qr') { alert("QR Code is required!"); return }; onChange({ ...design, elements: design.elements.filter(e => e.id !== selectedId) }); setSelectedId(null) }
  const applyTemplate = (key: keyof typeof TEMPLATES) => { onChange(TEMPLATES[key]); setSelectedId(null) }

  const handleBgImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]; if (!file) return; setIsUploading(true); const formData = new FormData(); formData.append("file", file)
    try { const token = localStorage.getItem("tickit_token") || ""; const response = await fetch("http://72.60.135.9:8080/api/v1/upload/image", { method: "POST", headers: { "Authorization": `Bearer ${token}` }, body: formData }); if (!response.ok) throw new Error("Upload failed"); const data = await response.json(); onChange({ ...design, bgImage: `http://72.60.135.9:8080${data.url}`, bgOverlay: 0.5 }) } 
    catch (error) { console.error(error); alert("Failed to upload background") } finally { setIsUploading(false) }
  }

  return (
    <div className="flex flex-col lg:flex-row gap-6 animate-in slide-in-from-bottom-4 duration-500">
      <div className="flex-1 flex flex-col items-center justify-center bg-secondary/10 rounded-xl border border-border/80 p-6 min-h-[600px] overflow-hidden shadow-inner">
        <div ref={containerRef} className="relative w-[320px] h-[550px] rounded-[2rem] shadow-2xl overflow-hidden ring-8 ring-secondary/40 select-none cursor-crosshair transition-colors bg-cover bg-center" style={{ backgroundColor: design.bgColor, backgroundImage: design.bgImage ? `url(${design.bgImage})` : 'none', touchAction: 'none' }} onPointerMove={handlePointerMove} onPointerUp={handlePointerUp} onPointerLeave={handlePointerUp} onPointerDown={() => setSelectedId(null)}>
          {design.bgImage && (<div className="absolute inset-0 pointer-events-none" style={{ backgroundColor: `rgba(0,0,0,${design.bgOverlay})` }} />)}
          <div className="absolute -left-4 top-[65%] w-8 h-8 rounded-full bg-background border-r-2 border-border/10 z-10" />
          <div className="absolute -right-4 top-[65%] w-8 h-8 rounded-full bg-background border-l-2 border-border/10 z-10" />
          <div className="absolute left-6 right-6 top-[65%] h-px border-t-2 border-dashed border-white/20 z-10" />
          {design.elements.map(el => (<div key={el.id} onPointerDown={(e) => handlePointerDown(e, el.id)} className={cn("absolute cursor-move transition-shadow px-2 py-1 rounded-md z-20 flex flex-col", selectedId === el.id ? "ring-2 ring-primary ring-offset-2 ring-offset-transparent bg-white/10" : "hover:ring-1 hover:ring-white/30")} style={{ left: el.type === 'text' && el.textAlign === 'center' ? el.x - 160 : el.x, top: el.y, color: el.color, fontSize: el.fontSize, fontWeight: el.fontWeight, fontFamily: el.fontFamily === 'mono' ? 'monospace' : el.fontFamily === 'serif' ? 'serif' : 'sans-serif', width: el.type === 'qr' ? el.fontSize : (el.textAlign === 'center' ? 320 : 'auto'), textAlign: el.textAlign || 'left' }}>{el.type === 'text' ? (<span className="leading-tight break-words">{renderSmartPreview(el.content)}</span>) : (<div className="w-full h-full bg-white rounded-xl flex items-center justify-center p-2 shadow-inner"><QrCode className="w-full h-full text-black" /></div>)}</div>))}
        </div>
        <span className="text-xs text-muted-foreground mt-6 uppercase tracking-widest font-bold">Mobile Ticket (320x550)</span>
      </div>

      <div className="w-full lg:w-[380px] flex flex-col gap-4">
        <Tabs defaultValue="elements" className="w-full">
          <TabsList className="grid w-full grid-cols-3"><TabsTrigger value="templates" className="text-xs"><LayoutTemplate className="h-3.5 w-3.5 mr-1.5"/> Presets</TabsTrigger><TabsTrigger value="background" className="text-xs"><ImageIcon className="h-3.5 w-3.5 mr-1.5"/> Canvas</TabsTrigger><TabsTrigger value="elements" className="text-xs"><Type className="h-3.5 w-3.5 mr-1.5"/> Elements</TabsTrigger></TabsList>
          
          <TabsContent value="templates" className="mt-4 flex flex-col gap-3"><Card className="border-border/60 shadow-sm"><CardContent className="p-4 flex flex-col gap-3"><span className="text-sm font-semibold mb-1">Quick Templates</span><Button variant="outline" className="justify-start gap-3 h-12" onClick={() => applyTemplate('minimalDark')}><div className="w-6 h-6 rounded bg-[#121212] border" /> Minimal Dark</Button><Button variant="outline" className="justify-start gap-3 h-12" onClick={() => applyTemplate('goldVip')}><div className="w-6 h-6 rounded bg-[#0f172a] border border-yellow-600/50" /> Gold VIP</Button><Button variant="outline" className="justify-start gap-3 h-12" onClick={() => applyTemplate('neonParty')}><div className="w-6 h-6 rounded bg-black border border-purple-500" /> Neon Party</Button></CardContent></Card></TabsContent>
          
          <TabsContent value="background" className="mt-4 flex flex-col gap-3"><Card className="border-border/60 shadow-sm"><CardContent className="p-5 flex flex-col gap-6"><div className="flex flex-col gap-3"><Label className="text-xs uppercase text-muted-foreground font-bold">Solid Color</Label><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full shadow-inner overflow-hidden border-2 border-border shrink-0"><input type="color" value={design.bgColor} onChange={(e) => onChange({ ...design, bgColor: e.target.value })} className="w-[200%] h-[200%] -translate-x-1/4 -translate-y-1/4 cursor-pointer" /></div><Input value={design.bgColor} onChange={(e) => onChange({ ...design, bgColor: e.target.value })} className="font-mono text-sm uppercase" /></div></div><Separator /><div className="flex flex-col gap-3"><Label className="text-xs uppercase text-muted-foreground font-bold">Background Image</Label><input type="file" ref={fileInputRef} onChange={handleBgImageUpload} accept="image/*" className="hidden" />{design.bgImage ? (<div className="flex flex-col gap-4"><div className="relative h-24 rounded-lg overflow-hidden border border-border group"><img src={design.bgImage} className="w-full h-full object-cover" crossOrigin="anonymous"/><Button variant="destructive" size="icon" className="absolute top-2 right-2 h-7 w-7 opacity-0 group-hover:opacity-100 transition-opacity" onClick={() => onChange({ ...design, bgImage: null })}><Trash className="h-3 w-3" /></Button></div><div className="flex flex-col gap-2"><div className="flex justify-between"><Label className="text-xs">Dark Overlay</Label><span className="text-xs text-muted-foreground">{Math.round(design.bgOverlay * 100)}%</span></div><Slider value={[design.bgOverlay]} max={1} step={0.05} onValueChange={(v) => onChange({ ...design, bgOverlay: v[0] })} /></div></div>) : (<Button variant="outline" className="w-full border-dashed h-12 gap-2 text-muted-foreground" onClick={() => fileInputRef.current?.click()} disabled={isUploading}>{isUploading ? <Loader2 className="h-4 w-4 animate-spin" /> : <Upload className="h-4 w-4" />} Upload Image</Button>)}</div></CardContent></Card></TabsContent>
          
          <TabsContent value="elements" className="mt-4 flex flex-col gap-3"><Card className="border-border/60 shadow-sm flex-1"><CardHeader className="pb-3 border-b mb-4 flex flex-row items-center justify-between"><CardTitle className="text-base">Editor</CardTitle>{selectedId && <Button variant="ghost" size="icon" className="h-7 w-7 text-destructive hover:bg-destructive/10 -mr-2" onClick={deleteSelected}><Trash className="h-4 w-4" /></Button>}</CardHeader><CardContent className="flex flex-col gap-5">{selectedElement ? (<div className="flex flex-col gap-5 animate-in fade-in slide-in-from-right-2"><Badge className="w-max">{selectedElement.type === 'qr' ? 'QR Code' : 'Text Block'}</Badge>{selectedElement.type === 'text' && (<div className="flex flex-col gap-2"><Label className="text-xs uppercase text-muted-foreground font-bold">Content (Tags supported)</Label><Input value={selectedElement.content} onChange={(e) => updateSelected({ content: e.target.value })} /></div>)}<div className="flex gap-4"><div className="flex flex-col gap-2 flex-1"><Label className="text-xs uppercase text-muted-foreground font-bold flex items-center gap-1"><Palette className="h-3 w-3"/> Color</Label><div className="flex items-center gap-2"><div className="w-8 h-8 rounded-md shadow-inner overflow-hidden border border-border shrink-0"><input type="color" value={selectedElement.color} onChange={(e) => updateSelected({ color: e.target.value })} className="w-[200%] h-[200%] -translate-x-1/4 -translate-y-1/4 cursor-pointer" /></div><Input value={selectedElement.color} onChange={(e) => updateSelected({ color: e.target.value })} className="h-8 text-xs font-mono uppercase" /></div></div><div className="flex flex-col gap-2 flex-1"><Label className="text-xs uppercase text-muted-foreground font-bold flex items-center gap-1"><Maximize className="h-3 w-3"/> Size</Label><Input type="number" value={selectedElement.fontSize} onChange={(e) => updateSelected({ fontSize: Number(e.target.value) })} className="h-8 text-xs font-mono" /></div></div>{selectedElement.type === 'text' && (<><div className="flex gap-4"><div className="flex flex-col gap-2 flex-1"><Label className="text-xs uppercase text-muted-foreground font-bold">Weight</Label><Select value={selectedElement.fontWeight} onValueChange={(v: 'normal'|'bold') => updateSelected({ fontWeight: v })}><SelectTrigger className="h-8 text-xs"><SelectValue /></SelectTrigger><SelectContent><SelectItem value="normal" className="text-xs">Normal</SelectItem><SelectItem value="bold" className="text-xs font-bold">Bold</SelectItem></SelectContent></Select></div><div className="flex flex-col gap-2 flex-1"><Label className="text-xs uppercase text-muted-foreground font-bold">Font</Label><Select value={selectedElement.fontFamily || 'sans'} onValueChange={(v: 'sans'|'serif'|'mono') => updateSelected({ fontFamily: v })}><SelectTrigger className="h-8 text-xs"><SelectValue /></SelectTrigger><SelectContent><SelectItem value="sans" className="text-xs font-sans">Sans</SelectItem><SelectItem value="serif" className="text-xs font-serif">Serif</SelectItem><SelectItem value="mono" className="text-xs font-mono">Mono</SelectItem></SelectContent></Select></div></div><div className="flex flex-col gap-2"><Label className="text-xs uppercase text-muted-foreground font-bold">Align</Label><div className="flex items-center gap-1 bg-secondary/30 p-1 rounded-lg border"><Button variant={selectedElement.textAlign === 'left' ? 'secondary' : 'ghost'} size="sm" className="flex-1 h-7" onClick={() => updateSelected({ textAlign: 'left' })}><AlignLeft className="h-3.5 w-3.5" /></Button><Button variant={selectedElement.textAlign === 'center' ? 'secondary' : 'ghost'} size="sm" className="flex-1 h-7" onClick={() => updateSelected({ textAlign: 'center' })}><AlignCenter className="h-3.5 w-3.5" /></Button><Button variant={selectedElement.textAlign === 'right' ? 'secondary' : 'ghost'} size="sm" className="flex-1 h-7" onClick={() => updateSelected({ textAlign: 'right' })}><AlignRight className="h-3.5 w-3.5" /></Button></div></div></>)}</div>) : (<div className="flex flex-col gap-4"><span className="text-sm text-muted-foreground leading-relaxed">Select an element on the canvas to edit, or add a new one below:</span><Button variant="default" className="justify-start gap-2 h-10 font-semibold w-full" onClick={() => addElement('New Text')}><Type className="h-4 w-4" /> Add Text Block</Button><Separator className="my-1" /><Label className="text-xs uppercase text-muted-foreground font-bold">Smart Tags</Label><div className="grid grid-cols-2 gap-2"><Button variant="outline" className="text-xs h-9 border-dashed font-mono" onClick={() => addElement('{{Event_Name}}')}>+ Event Name</Button><Button variant="outline" className="text-xs h-9 border-dashed font-mono" onClick={() => addElement('{{Event_Date}}')}>+ Date & Time</Button><Button variant="outline" className="text-xs h-9 border-dashed font-mono bg-primary/5 text-primary border-primary/20" onClick={() => addElement('{{Guest_Name}}')}>+ Guest Name</Button><Button variant="outline" className="text-xs h-9 border-dashed font-mono bg-primary/5 text-primary border-primary/20" onClick={() => addElement('{{Ticket_Type}}')}>+ Ticket Type</Button></div><span className="text-[10px] text-muted-foreground text-center mt-2">Smart tags automatically fill with buyer data.</span></div>)}</CardContent></Card></TabsContent>
        </Tabs>
      </div>
    </div>
  )
}